# 多項式を用いた回帰

ここでは多項式回帰とlogを用いた回帰分析の方法について紹介します。以下では`use http://www.stata-press.com/data/r13/regress`で得られるデータセットを用いていきます。Doファイルの最初の部分は以下のように変わります。

Doファイルの最初の部分：
```
clear all

capture log close

cd "/Users/akirasato/Docs/Okamuro_Seminar/stata_introduction"

log using stataoutput, replace

use http://www.stata-press.com/data/r13/regress
```

このデータセットには`y, x1, x2, x3`の4つの変数が含まれており，`x2`はバイナリ変数（0か-1のみをとる変数）となっています。データの概要は以下のようになっています。

```
    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
           y |        148     21.2973    5.765791         12         41
          x1 |        148    3.014865    .4547325       2.19       3.89
          x2 |        148   -.2972973    .4586205         -1          0
          x3 |        148    3019.459    774.5455       1760       4840
```

ここでは以下の式で表される回帰分析を考えます。

$$
Y_i = \beta_{0i} + \beta_1 X_{1i} + \beta_2 X_{1i}^2 + u_i
$$

この回帰分析は以下のコマンドで行います。

コマンド：
```
gen x1_quad = x1^2
reg y x1 x1_quad, r
```

結果：
```
. gen x1_quad = x1^2

. reg y x1 x1_quad, r

Linear regression                               Number of obs     =        148
                                                F(2, 145)         =      47.53
                                                Prob > F          =     0.0000
                                                R-squared         =     0.3801
                                                Root MSE          =     4.5708

------------------------------------------------------------------------------
             |               Robust
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          x1 |   4.390219   10.93276     0.40   0.689    -17.21794    25.99837
     x1_quad |   .5584249   1.845402     0.30   0.763    -3.088938    4.205788
       _cons |   2.870936   15.89852     0.18   0.857    -28.55184    34.29371
------------------------------------------------------------------------------
```

まず，`gen`コマンド（`generate`の略です）を用いて新しい変数を作成します。ここでの`gen x1_quad = x1^2`とは，`x1_quad`という変数を作成し，その値は`x1^2`，つまり`x1`の2乗に等しくなるようにせよ，ということです。あとは4.1で紹介した方法と同様に`reg`コマンドを使います。

次に$$X_{1}$$を1増加させた時に$$Y$$がどれくらい上昇するかを考えます。先程の回帰式の$$X_{1}$$を$$X_{1} + 1$$に置き換えると回帰式は以下のようになります。

$$
Y_{i}^+ = \beta_{0i} + \beta_1 (X_{1i} + 1) + \beta_2 (X_{1i} + 1)^2 + u_i
$$

冒頭の回帰式と辺々を引くと，

$$
Y_{i}^+ - Y_i = \beta_1 + \beta_2 (2 X_{1i} + 1)
$$

を得ることができ，この右辺が$$X_{1}$$を1上昇させた時の$$Y$$の上昇幅になります。ここでは$$X_{1}$$が2から3に上昇することを考えます。$$Y$$の上昇は$$\beta_1 + \beta_2 (2\times2 + 1)$$となります。これがどのような値になるかをStataで出力するためには`lincom`コマンドを使います。

コマンド：
```
* ここではx1はx1の回帰係数，x1_quadはx1^2の回帰係数
* 5 * x1_quadは21とx1_quadをかけることを意味します。
lincom x1 + 5 * x1_quad
```

結果：
```
. lincom x1 + 5 * x1_quad

 ( 1)  x1 + 5*x1_quad = 0

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   7.182343     1.8536     3.87   0.000     3.518777    10.84591
------------------------------------------------------------------------------
```

これより，$$X_1$$を2から3に上昇させたとき，$$Y$$は7.18だけ上昇することがわかりました。

# $$\log$$を用いた回帰

ここでは$$\log$$を用いた回帰分析について説明します。以下の回帰式を考えます。

$$
Y_i = \beta_0 + \beta_1 \log (X_{1i}) + \beta_2 X_{3i} + u_i
$$

これは以下のコマンドで実行できます。

コマンド：
```
gen log_x1 = log(x1)
reg y log_x1 x3, r
```

結果：
```
. gen log_x1 = log(x1)

. reg y log_x1 x3, r

Linear regression                               Number of obs     =        148
                                                F(2, 145)         =     129.90
                                                Prob > F          =     0.0000
                                                R-squared         =     0.6516
                                                Root MSE          =     3.4267

------------------------------------------------------------------------------
             |               Robust
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
      log_x1 |  -.4577455   2.800982    -0.16   0.870    -5.993774    5.078283
          x3 |  -.0060771   .0004493   -13.53   0.000    -.0069651   -.0051891
       _cons |   40.14677   3.938881    10.19   0.000     32.36173    47.93181
------------------------------------------------------------------------------
```

これも先ほどと同様で，`gen log_x1 = log(x1)`の部分で新たに$$\log (X_{1i})$$を表す変数`log_x1`を作成したあとに，この変数と`x3`に関して回帰分析を行なっています。

### $$\log$$を用いた分析に関する一般的な注意

$$\log$$を用いた分析ではデータに0が含まれる場合はStataは自動でそのデータを落とします。これに対処するには，

1. そのままなにもしない（影響が少ない場合）
2. 1や0.1といった値を一律で加えて0のデータをなくす
3. rankを利用する

などがありますが，2はどのような値を加えるかによって大きく結果が異なることに注意しましょう。